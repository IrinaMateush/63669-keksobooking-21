(()=>{"use strict";(()=>{const e="https://21.javascript.pages.academy/keksobooking";window.backend={workWithServer:(t,o,n)=>{const r=new XMLHttpRequest;return r.responseType="json",r.addEventListener("load",(()=>{200===r.status&&n(r.response)})),r.addEventListener("error",(()=>{window.form.errorLoadHandler()})),r.open(t,o),o===e?r.send(new FormData(window.form.noticeBlank)):r.send()},LOAD_URL:"https://21.javascript.pages.academy/keksobooking/data",UPLOAD_URL:e}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),300)}},(()=>{const e="any",t=document.querySelector("#housing-type"),o=document.querySelector("#housing-price"),n=document.querySelector("#housing-rooms"),r=document.querySelector("#housing-guests"),i=document.querySelector("#filter-wifi"),a=document.querySelector("#filter-dishwasher"),d=document.querySelector("#filter-parking"),s=document.querySelector("#filter-washer"),c=document.querySelector("#filter-elevator"),l=document.querySelector("#filter-conditioner"),u=document.querySelectorAll(".map__checkbox"),m=document.querySelectorAll(".map__filter"),w=()=>{const e=document.querySelector(".popup");if(null!==e&&e.remove(),null!==window.pinElements)for(const e of window.pinElements)e.remove()},p=(e,t)=>(w(),t.checked?e.filter((e=>e.offer.features.includes(t.value))):e),f=()=>{var u;const m=(e=>{w();let t=e;return"low"===o.value?t=e.filter((e=>e.offer.price<1e4)):"middle"===o.value?t=e.filter((e=>e.offer.price>1e3&&e.offer.price<5e4)):"higt"===o.value&&(t=e.filter((e=>e.offer.price>5e4))),t})((t=>(w(),r.value===e?t:t.filter((e=>String(e.offer.guests)===r.value))))((t=>(w(),n.value===e?t:t.filter((e=>String(e.offer.rooms)===n.value))))((u=window.data.pins,w(),t.value===e?u:u.filter((e=>String(e.offer.type)===t.value)))))),f=p(m,i),v=p(f,a),y=p(v,d),g=p(y,s),h=p(g,c),S=p(h,l);window.main.addPinsToMap(S)};for(const e of m)e.addEventListener("change",window.debounce(f));for(const e of u)e.addEventListener("change",window.debounce(f));window.filter={removeElements:w}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".map"),o=document.querySelector(".map__pins"),n=e=>{const t=document.createDocumentFragment(),n=e.length<5?e.length:5;for(let o=0;o<n;o++)t.appendChild(window.map.renderPin(e[o]));o.appendChild(t);const i=document.querySelectorAll(".map__pin:not(.map__pin--main)");window.pinElements=i;for(const e of i)e.addEventListener("click",(()=>{const t=e.querySelector("img").getAttribute("src");window.map.openAdvertising(t),document.querySelector(".popup").querySelector(".popup__close").addEventListener("click",r)}))},r=()=>{const e=document.querySelector(".popup");window.map.closePopup(e)},i=()=>{e.removeEventListener("keydown",a),document.removeEventListener("keydown",window.form.successEscPressHandler),document.removeEventListener("keydown",window.form.errorEscPressHandler),t.classList.remove("map--faded"),window.map.filtersContainer.classList.remove("ad-form--disabled"),window.form.noticeBlank.classList.remove("ad-form--disabled"),window.form.noticeAvatar.removeAttribute("disabled","disabled"),window.form.noticeDescription.removeAttribute("disabled","disabled"),window.form.activateFields(window.map.selectFilters),window.form.activateFields(window.map.checkboxFilters),window.form.activateFields(window.form.noticeInputs),window.form.activateFields(window.form.noticeSelects),window.form.changeCursorPointer(window.map.selectFilters),window.form.changeCursorPointer(window.map.labelFilters),window.form.noticeAddress.setAttribute("value",window.move.orangePinCenterX+", "+window.move.orangePinTailY)},a=e=>{"Enter"===e.key&&i(window.backend.workWithServer("GET",window.backend.LOAD_URL,window.main.successLoadHandler))};e.addEventListener("keydown",a),window.main={orangePin:e,map:t,activationСard:i,successLoadHandler:e=>{window.data.pins=e,n(window.data.pins),window.main.orangePin.removeEventListener("click",window.move.pinsHandler),i()},addPinsToMap:n,pressCrossHandler:r}})(),(()=>{const e=window.main.map.offsetLeft,t=window.main.map.offsetWidth+e,o=window.main.orangePin.offsetWidth/2,n=e=>{const t=e.getBoundingClientRect();return{top:Math.round(t.top+pageYOffset),left:Math.round(t.left+pageXOffset)}},r=n(window.main.orangePin).left-e,i=n(window.main.orangePin).top;let a=Math.round(n(window.main.orangePin).left+o),d=Math.round(n(window.main.orangePin).top+o),s=Math.round(d+o+22);const c=()=>{window.main.activationСard(window.backend.workWithServer("GET",window.backend.LOAD_URL,window.main.successLoadHandler))};window.main.orangePin.addEventListener("click",c),window.main.orangePin.addEventListener("mousedown",(n=>{if(n.preventDefault(),1===n.which){let r={x:n.clientX,y:n.clientY};const i=n=>{n.preventDefault();const i=r.x-n.clientX,c=r.y-n.clientY;r={x:n.clientX,y:n.clientY};let l=window.main.orangePin.offsetTop-c,u=window.main.orangePin.offsetLeft-i,m=u+e+o;u<=-o?u=-o:m>=t&&(u=t-e-o),l<=130?l=130:l>=630&&(l=630),window.main.orangePin.style.top=l+"px",window.main.orangePin.style.left=u+"px",a=Math.round(window.main.orangePin.getBoundingClientRect().x+o),d=Math.round(window.main.orangePin.getBoundingClientRect().y+o),s=Math.round(d+o+22),window.form.noticeAddress.setAttribute("value",a+", "+s)},c=e=>{e.preventDefault(),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",c)}})),window.move={orangePinTailY:s,pinsHandler:c,orangePinCenterX:a,orangePinCenterY:d,orangePinPositionX:r,orangePinPositionY:i}})(),(()=>{const e=document.querySelector("#success").content.querySelector(".success"),t=document.querySelector("#error").content.querySelector(".error"),o={palace:"Дворец",flat:"Квартира",house:"Дом",bungalo:"Бунгало",undefined:"Неожиданный тип жилья"},n={palace:1e4,flat:1e3,house:5e3,bungalo:0};window.data={FEATURES:["wifi","dishwasher","parking","washer","elevator","conditioner"],PHOTOS:["http://o0.github.io/assets/images/tokyo/hotel1.jpg","http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"],TYPES:["palace","flat","house","bungalo"],CHECKINTIMES:["12:00","13:00","14:00"],CHECKOUTTIMES:["12:00","13:00","14:00"],pins:[],getRandomInt:(e,t)=>(e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e),getLivingType:e=>o[e.offer.type],getLivingTypeCost:e=>n[e.value],getCapacity:e=>{let t="";const o=e.offer.guests+(1===e.offer.guests?" гостя":" гостей");return t=1===e.offer.rooms?" комната для ":e.offer.rooms>1&&e.offer.rooms<5?" комнаты для ":" комнат для ",e.offer.rooms+t+o},createPhoto:(e,t)=>{const o=t.cloneNode(!0);return o.src=e,o},renderSuccessMessage:()=>e.cloneNode(!0),renderErrorMessage:()=>t.cloneNode(!0)}})(),(()=>{const e=window.main.map.querySelector(".map__filters-container"),t=e.querySelectorAll(".map__filter"),o=e.querySelectorAll(".map__checkbox"),n=e.querySelectorAll(".map__feature"),r=document.querySelector("#pin").content.querySelector(".map__pin");e.classList.add("ad-form--disabled");const i=e=>{const t=e.querySelector(".popup__close");e.remove(),document.removeEventListener("keydown",a),t.removeEventListener("click",window.main.pressCrossHandler)};window.main.orangePin.addEventListener("click",window.move.pinsHandler);const a=e=>{const t=document.querySelector(".popup");"Escape"===e.key&&(e.preventDefault(),i(t))};window.map={filtersContainer:e,selectFilters:t,checkboxFilters:o,labelFilters:n,renderPin:e=>{const t=r.cloneNode(!0);return t.style.left=e.location.x-23+"px",t.style.top=e.location.y-64+"px",t.setAttribute("tabindex",0),t.querySelector("img").setAttribute("alt",e.offer.title),t.querySelector("img").setAttribute("src",e.author.avatar),t},closePopup:i,openAdvertising:e=>{const t=document.querySelector(".popup");null!==t&&t.remove();const o=document.createDocumentFragment();for(const t of window.data.pins)t.author.avatar===e&&o.appendChild(window.card.renderAdvertising(t));window.main.map.insertBefore(o,window.map.filtersContainer),document.addEventListener("keydown",a)}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=(e,t)=>void 0===t?e.classList.add("hidden"):e.textContent=t;window.card={renderAdvertising:o=>{const n=e.cloneNode(!0);var r,i,a;return((e,t)=>{const o=e.offer.photos,n=t.querySelector(".popup__photos"),r=n.querySelector(".popup__photo"),i=document.createDocumentFragment();for(let e=0;e<o.length;e++)0===e?r.src=o[e]:i.appendChild(window.data.createPhoto(o[e],r));i.children.length?n.appendChild(i):n.classList.add("hidden")})(o,n),t(n.querySelector(".popup__title"),o.offer.title),t(n.querySelector(".popup__text--address"),o.offer.address),t(n.querySelector(".popup__text--price"),o.offer.price+" ₽/ночь"),t(n.querySelector(".popup__type"),window.data.getLivingType(o)),t(n.querySelector(".popup__text--capacity"),window.data.getCapacity(o)),t(n.querySelector(".popup__features"),o.offer.features),t(n.querySelector(".popup__description"),o.offer.description),r=n.querySelector(".popup__text--time"),i=o.offer.checkin,a=o.offer.checkout,void 0===i||void 0===a?r.classList.add("hidden"):r.textContent="Заезд после "+i+", выезд до "+a,((e,t)=>{void 0===t?e.classList.add("hidden"):e.setAttribute("src",t)})(n.querySelector(".popup__avatar"),o.author.avatar),n}}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("form.ad-form"),o=t.querySelector("#avatar"),n=t.querySelector("#room_number"),r=t.querySelector("#title"),i=t.querySelector("#capacity"),a=t.querySelector("#address"),d=t.querySelector("#timein"),s=t.querySelector("#timeout"),c=t.querySelector("#type"),l=t.querySelector("#price"),u=t.querySelector(".ad-form__reset"),m=document.querySelectorAll(".ad-form__element input"),w=document.querySelectorAll(".ad-form__element select"),p=document.querySelector("#description");l.setAttribute("placeholder",1e3),l.setAttribute("min",1e3);const f=e=>{for(const t of e)t.setAttribute("disabled","disabled")},v=e=>{for(const t of e)t.style.cursor="default"},y=()=>{f(window.map.selectFilters),f(window.map.checkboxFilters),v(window.map.selectFilters),v(window.map.labelFilters),f(m),f(w),p.setAttribute("disabled","disabled"),o.setAttribute("disabled","disabled"),t.classList.add("ad-form--disabled"),window.main.orangePin.style.top=window.move.orangePinPositionY+"px",window.main.orangePin.style.left=window.move.orangePinPositionX+"px"};y(),a.setAttribute("placeholder",window.move.orangePinCenterX+", "+window.move.orangePinCenterY);const g=()=>{"1"===n.value&&"1"!==i.value?n.setCustomValidity("1 комната только для 1 гостя"):"100"===n.value&&"0"!==i.value?n.setCustomValidity("Is not correct"):"2"!==n.value||"3"!==i.value&&"0"!==i.value?"3"===n.value&&"0"===i.value?n.setCustomValidity("Для 3 или менее гостей"):n.setCustomValidity(""):n.setCustomValidity("Для 2 и менее гостей"),n.reportValidity()},h=(e,t)=>{const o=e.querySelectorAll("option");for(const e of o)e.value===t.value&&(e.selected=!0)},S=()=>{const t=document.createDocumentFragment();t.appendChild(window.data.renderErrorMessage()),e.insertBefore(t,window.main.map);const o=document.querySelector(".error");o.addEventListener("click",(()=>{o.remove()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(e.preventDefault(),o.remove())}))};u.addEventListener("click",(()=>{t.reset(),window.filter.removeElements(),y(),window.form.noticeAddress.setAttribute("value",window.move.orangePinCenterX+", "+window.move.orangePinTailY),window.main.orangePin.addEventListener("click",window.move.pinsHandler)}));const q=()=>{t.reset(),y(),(()=>{const t=document.createDocumentFragment();t.appendChild(window.data.renderSuccessMessage()),e.insertBefore(t,window.main.map);const o=document.querySelector(".success");document.addEventListener("click",(()=>{o.remove()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&(e.preventDefault(),o.remove())}))})(),window.filter.removeElements(),window.form.noticeAddress.setAttribute("value",window.move.orangePinCenterX+", "+window.move.orangePinTailY)};t.addEventListener("submit",(e=>{e.preventDefault(),(()=>{let e=!0;return"1"===n.value&&"1"!==i.value?(n.setCustomValidity("1 комната только для 1 гостя"),n.reportValidity(),e=!1):r.validity.valueMissing?(r.setCustomValidity("Обязательное поле"),r.reportValidity(),e=!1):l.validity.valueMissing?(l.setCustomValidity("Обязательное поле"),l.reportValidity(),e=!1):r.validity.tooLong?(r.setCustomValidity("Максимальная длина - 100 символов"),r.reportValidity(),e=!1):r.validity.tooShort?(r.setCustomValidity("Минимальная длина - 30 символов"),r.reportValidity(),e=!1):l.validity.rangeOverflow?(l.setCustomValidity("Максимальное значение 1000000"),l.reportValidity(),e=!1):(n.setCustomValidity(""),r.setCustomValidity(""),l.setCustomValidity("")),e})()&&(window.backend.workWithServer("POST",window.backend.UPLOAD_URL,q),window.main.orangePin.addEventListener("click",window.move.pinsHandler))})),i.addEventListener("change",g),n.addEventListener("change",g),d.addEventListener("change",(()=>{h(s,d)})),s.addEventListener("change",(()=>{h(d,s)})),c.addEventListener("change",(()=>{const e=window.data.getLivingTypeCost(c);l.setAttribute("placeholder",e),l.setAttribute("min",e)})),window.form={noticeBlank:t,noticeInputs:m,noticeSelects:w,noticeDescription:p,noticeAvatar:o,noticeAddress:a,activateFields:e=>{for(const t of e)t.removeAttribute("disabled","disabled")},changeCursorPointer:e=>{for(const t of e)t.style.cursor="pointer"},errorLoadHandler:()=>{S()},showError:S}})()})();